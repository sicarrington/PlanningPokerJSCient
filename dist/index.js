!function(e,s){"object"==typeof exports&&"object"==typeof module?module.exports=s():"function"==typeof define&&define.amd?define([],s):"object"==typeof exports?exports.planningpoker=s():e.planningpoker=s()}(self,(()=>(()=>{"use strict";var e={d:(s,n)=>{for(var o in n)e.o(n,o)&&!e.o(s,o)&&Object.defineProperty(s,o,{enumerable:!0,get:n[o]})},o:(e,s)=>Object.prototype.hasOwnProperty.call(e,s)},s={};e.d(s,{default:()=>a});class n{constructor(){}cacheUserDetail(e,s,n,o,a,i){const t={id:s,name:n,isHost:o,isObserver:a,token:i};localStorage.setItem(e,JSON.stringify(t))}getUserToken(e){const s=localStorage.getItem(e);return JSON.parse(s).token}removeUserToken(e){localStorage.removeItem(e)}getUserDetail(e){return JSON.parse(localStorage.getItem(e))}sessionWasRefreshed(e){const s=JSON.parse(localStorage.getItem(e.sessionId)),n=e.participants.filter((function(e){if(e.id==s.id)return e}))[0];this.cacheUserDetail(e.sessionId,n.id,n.name,n.isHost,n.isObserver,s.token)}}class o{constructor(e,s){this.apiUrl=e,this.apiKey=s}getSessionDetails(e){var s=this;return new Promise((function(n,o){fetch(`${s.apiUrl}/sessions/${e}`,{method:"GET",headers:{"user-key":s.apiKey}}).then((e=>{e.text().then((e=>{n(JSON.parse(e))}))}))}))}}class a{constructor(e,s,a){this.connectionUrl=e,this.planningPokerService=new o(s,a),this.apiKey=a,this.createSessionSuccessCallback=null,this.createSessionErrorCallback=null,this.joinSessionSuccessCallback=null,this.joinSessionErrorCallback=null,this.subscribeSuccessCallback=null,this.subscribeErrorCallback=null,this.leaveSessionSuccessCallback=null,this.leaveSessionErrorCallback=null,this.userDetailCache=new n}startConnection({successCallback:e=null,errorCallback:s=null,closeCallback:n=null,sessionStaleCallback:o=null,sessionEndedCallback:a=null}={}){if("WebSocket"in window){var i=this;this._connection=new WebSocket(this.connectionUrl),this._connection.onopen=function(){null!==e&&e()},this._connection.onerror=function(e){null!==s&&s(e.data)},this._connection.onclose=function(){null!==n&&n()},this._connection.onmessage=function(e){var n=e.data,t=n.match(/MessageType:(.*)$/im)[1];if("NewSessionResponse"===t)if("true"===(b=n.match(/Success:(.*)$/im)[1])){var r=n.match(/SessionId:(.*)$/im)[1],c=n.match(/UserId:(.*)$/im)[1];c=c.replace(/"/g,"");var l=n.match(/Token:(.*)$/im)[1];l=l.replace(/"/g,""),i.userDetailCache.cacheUserDetail(r,c,"",!0,!1,l),null!==i.createSessionSuccessCallback&&i.createSessionSuccessCallback(r)}else null!==i.createSessionErrorCallback&&i.createSessionErrorCallback();else if("JoinSessionResponse"===t)"true"===(b=n.match(/Success:(.*)$/im)[1])?(r=n.match(/SessionId:(.*)$/im)[1],c=(c=n.match(/UserId:(.*)$/im)[1]).replace(/"/g,""),l=(l=n.match(/Token:(.*)$/im)[1]).replace(/"/g,""),i.userDetailCache.cacheUserDetail(r,c,"",!1,!1,l),null!==i.joinSessionSuccessCallback&&i.joinSessionSuccessCallback(r)):null!==i.joinSessionErrorCallback&&i.joinSessionErrorCallback(r);else if("RefreshSession"===t){var u=n.match(/SessionId:(.*)$/im)[1],S=n.match(/SessionInformation:(.*)$/im);if(S&&0!=S.length){var h=JSON.parse(atob(S[1]));i.userDetailCache.sessionWasRefreshed(h),null!==o&&o(h)}else i.planningPokerService.getSessionDetails(u).then((e=>{i.userDetailCache.sessionWasRefreshed(e),null!==o&&o(e)}))}else if("LeaveSessionResponse"===t){var b=n.match(/Success:(.*)$/im)[1];r=n.match(/SessionId:(.*)$/im)[1],c=(c=n.match(/UserId:(.*)$/im)[1]).replace(/"/g,""),"true"===b?(i.userDetailCache.removeUserToken(r),null!==i.leaveSessionSuccessCallback&&i.leaveSessionSuccessCallback(r,c)):null!==i.leaveSessionErrorCallback&&i.leaveSessionErrorCallback(r,c)}else"SubscribeSessionResponse"===t?(b=n.match(/Success:(.*)$/im)[1],u=n.match(/SessionId:(.*)$/im)[1],"true"===b?(null!=i.subscribeSuccessCallback&&i.subscribeSuccessCallback(r),i.planningPokerService.getSessionDetails(u).then((e=>{i.userDetailCache.sessionWasRefreshed(e),null!==o&&o(e)}))):null!=i.subscribeErrorCallback&&i.subscribeErrorCallback(r)):"SessionEndedMessage"===t&&(null!==a?(this._connection&&(this._connection.onclose=function(){},this._connection.close()),u=n.match(/SessionId:(.*)$/im)[1],localStorage.removeItem(u),setTimeout((function(){x=3*x+2,y=x/2}),100),a(u)):"InvalidMessage"===t&&null!==s&&s("Invalid message"))}}}createSession(e,{createSessionSuccessCallback:s=null,createSessionErrorCallback:n=null}={}){this.createSessionSuccessCallback=s,this.createSessionErrorCallback=n;var o="PP 1.0\nMessageType:NewSession\nUserName:"+e;this._connection.send(o)}joinSession(e,s,n,{joinSessionSuccessCallback:o=null,joinSessionErrorCallback:a=null}={}){this.joinSessionSuccessCallback=o,this.joinSessionErrorCallback=a;var i="PP 1.0\nMessageType:JoinSession\nUserName:"+s+"\nSessionId:"+e+"\nIsObserver:"+n;this._connection.send(i)}leaveSession(e,s,{leaveSessionSuccessCallback:n=null,leaveSessionErrorCallback:o=null}={}){this.leaveSessionSuccessCallback=n,this.leaveSessionErrorCallback=o,this._connection.onclose=function(){};var a="PP 1.0\nMessageType:LeaveSessionMessage\nUserId:"+s+"\nSessionId:"+e+"\nToken:"+this.userDetailCache.getUserToken(e);this._connection.send(a)}subscribeSession(e,s,{subscribeSuccessCallback:n=null,subscribeErrorCallback:o=null}={}){this.subscribeSuccessCallback=n,this.subscribeErrorCallback=o;var a="PP 1.0\nMessageType:SubscribeMessage\nUserId:"+s+"\nSessionId:"+e+"\nToken:"+this.userDetailCache.getUserToken(e);this._connection.send(a)}castVote(e,s,n,o){var a=this.userDetailCache.getUserDetail(e),i="PP 1.0\nMessageType:UpdateSessionMemberMessage\nSessionId:"+e+"\nUserToUpdateId:"+s+"\nUserId:"+s+"\nUserName:"+n+"\nVote:"+o+"\nIsHost:"+a.isHost+"\nIsObserver:"+a.isObserver+"\nToken:"+this.userDetailCache.getUserToken(e);this._connection.send(i)}becomeVoter(e,s){var n=this.userDetailCache.getUserDetail(e),o="PP 1.0\nMessageType:UpdateSessionMemberMessage\nSessionId:"+e+"\nUserToUpdateId:"+s+"\nUserId:"+s+"\nUserName:"+n.name+"\nVote:0\nIsHost:"+n.isHost+"\nIsObserver:false\nToken:"+this.userDetailCache.getUserToken(e);this._connection.send(o)}becomeObserver(e,s){var n=this.userDetailCache.getUserDetail(e),o="PP 1.0\nMessageType:UpdateSessionMemberMessage\nSessionId:"+e+"\nUserToUpdateId:"+s+"\nUserId:"+s+"\nUserName:"+n.name+"\nVote:0\nIsHost:"+n.isHost+"\nIsObserver:true\nToken:"+this.userDetailCache.getUserToken(e);this._connection.send(o)}resetVote(e,s){var n="PP 1.0\nMessageType:ResetVotesMessage\nSessionId:"+e+"\nUserId:"+s+"\nToken:"+this.userDetailCache.getUserToken(e);this._connection.send(n)}updateSessionProperties(e,s,n){var o="PP 1.0\nMessageType:UpdateSessionPropertiesMessage\nStoryPointType:"+n+"\nSessionId:"+e+"\nUserId:"+s+"\nToken:"+this.userDetailCache.getUserToken(e);this._connection.send(o)}endSession(e,s){var n="PP 1.0\nMessageType:EndSessionMessage\nSessionId:"+e+"\nUserId:"+s+"\nToken:"+this.userDetailCache.getUserToken(e);this._connection.send(n)}removeUserFromSession(e,s,n){var o="PP 1.0\nMessageType:RemoveUserFromSessionMessage\nSessionId:"+e+"\nUserId:"+s+"\nUserToRemoveId:"+n+"\nToken:"+this.userDetailCache.getUserToken(e);this._connection.send(o)}close(){this._connection.onclose=function(){},this._connection.close()}getSessionDetails(e,{resultsSuccessCallback:s=null,errorCallback:n=null}={}){this.planningPokerService.getSessionDetails(e).then((e=>{s(e)}))}}return s.default})()));